<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="OFC Assistant">
  <title>OFC Assistant — PWA</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f3f4f7;color:#111}
    .safe{padding:env(safe-area-inset-top) 16px calc(16px + env(safe-area-inset-bottom)) 16px;max-width:980px;margin:0 auto}
    h1{margin:12px 0}.muted{color:#666;font-size:14px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.06);margin-top:16px}
    .wrap{display:grid;grid-template-columns:1fr 1.15fr 1fr;gap:12px;margin-top:12px}
    .col{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;box-shadow:0 2px 4px rgba(0,0,0,.04)}
    .row-name{font-weight:700;margin:6px 0;font-size:14px}
    .slots{display:grid;grid-template-columns:repeat(5,56px);gap:8px;margin-bottom:8px}
    .slot{width:56px;height:76px;border:1px dashed #bbb;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#fff;font-weight:700;color:#333;cursor:pointer}
    .deck{display:grid;grid-template-columns:repeat(13,42px);gap:6px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;cursor:pointer}
    .btn2{padding:10px 14px;border-radius:10px;border:1px solid #999;background:#fff;color:#111;margin-left:6px}
    .ctrl{display:flex;flex-wrap:wrap;gap:8px;align-items:end;margin-bottom:8px}
    .unit{display:flex;flex-direction:column;gap:4px}.unit input{width:100px;padding:8px;border:1px solid #ccc;border-radius:8px}
    .cb{width:42px;height:62px;border:1px solid #aaa;border-radius:8px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;position:relative}
    .cb.disabled{opacity:.3;pointer-events:none}.suit{position:absolute;bottom:2px;right:4px;font-size:12px}
    .red{color:#c62828}.black{color:#111}
    table{border-collapse:collapse;width:100%}th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
  </style>
</head>
<body>
<div class="safe">
  <h1>OFC Assistant — PWA</h1>
  <p class="muted">Карточный пикер без дублей, визуальный стол для двух игроков и подсчёт очков по «американским» роялти. Работает офлайн. Добавьте на экран «Домой».</p>

  <div class="wrap">
    <div class="col">
      <h2>Игрок 1 (Вы)</h2>
      <div class="row-name">Верх (3)</div><div class="slots" data-g="p1_top" data-n="3"></div>
      <div class="row-name">Середина (5)</div><div class="slots" data-g="p1_mid" data-n="5"></div>
      <div class="row-name">Низ (5)</div><div class="slots" data-g="p1_bot" data-n="5"></div>
    </div>

    <div class="col">
      <div class="ctrl">
        <button class="btn2" id="reset">Сбросить</button>
        <button class="btn2" id="demo">Демо</button>
        <div class="unit"><label>₽/очко</label><input type="number" id="unit" min="1" step="1" value="50"></div>
        <button class="btn" id="calc">Посчитать</button>
      </div>
      <div class="deck" id="deck"></div>
    </div>

    <div class="col">
      <h2>Игрок 2 (Оппонент)</h2>
      <div class="row-name">Верх (3)</div><div class="slots" data-g="p2_top" data-n="3"></div>
      <div class="row-name">Середина (5)</div><div class="slots" data-g="p2_mid" data-n="5"></div>
      <div class="row-name">Низ (5)</div><div class="slots" data-g="p2_bot" data-n="5"></div>
    </div>
  </div>

  <div id="result" class="card" hidden>
    <h3>Итог</h3>
    <div id="sum"></div>
    <table>
      <thead><tr><th>Линия</th><th>Победа</th><th>Роялти P1</th><th>Роялти P2</th></tr></thead>
      <tbody id="lines"></tbody>
    </table>
    <p class="muted" id="notes"></p>
  </div>

  <div class="card">
    <h3>Подсказки</h3>
    <ul>
      <li>Верх: пары 66–AA → 1–9; тройки 222–AAA → 10–22.</li>
      <li>Середина: сет 2, стрит 4, флеш 8, фулл 12, каре 20, стрит‑флеш 30, роял‑флеш 50.</li>
      <li>Низ: стрит 2, флеш 4, фулл 6, каре 10, стрит‑флеш 15, роял‑флеш 25.</li>
      <li>Фолт: −6 фолтящему, +6 и роялти сопернику. Скууп: победа на всех линиях +3.</li>
    </ul>
  </div>
</div>

<script>
(()=> {
  const RANKS = ["2","3","4","5","6","7","8","9","T","J","Q","K","A"];
  const SUITS = ["s","h","d","c"];
  const sym = {s:"♠",h:"♥",d:"♦",c:"♣"}, col={s:"black",c:"black",h:"red",d:"red"};
  const R2V = {}; RANKS.forEach((r,i)=>R2V[r]=i+2);

  const RB = {straight:2,flush:4,full_house:6,four_kind:10,straight_flush:15,royal_flush:25};
  const RM = {three_kind:2,straight:4,flush:8,full_house:12,four_kind:20,straight_flush:30,royal_flush:50};
  const TP = {6:1,7:2,8:3,9:4,10:5,11:6,12:7,13:8,14:9};
  const TT = {2:10,3:11,4:12,5:13,6:14,7:15,8:16,9:17,10:18,11:19,12:20,13:21,14:22};

  function slotsBuild(){
    document.querySelectorAll('.slots').forEach(el=>{
      const n=+el.dataset.n;
      for(let i=0;i<n;i++){
        const s=document.createElement('div');
        s.className='slot'; s.addEventListener('click',()=>rm(s));
        el.appendChild(s);
      }
    });
  }
  function deckBuild(){
    const d=document.getElementById('deck');
    RANKS.forEach(r=>SUITS.forEach(s=>{
      const code=r+s;
      const b=document.createElement('button');
      b.type='button'; b.className='cb '+col[s]; b.dataset.card=code;
      b.innerHTML=`<span>${r}</span><span class="suit">${sym[s]}</span>`;
      b.addEventListener('click',()=>place(code));
      d.appendChild(b);
    }));
  }
  function disable(code,on){
    const b=document.querySelector(`.cb[data-card="${code}"]`); if(!b)return;
    b.classList.toggle('disabled',!!on);
  }
  function place(code){
    const order=['p1_top','p1_mid','p1_bot','p2_top','p2_mid','p2_bot'];
    for(const g of order){
      const cont=document.querySelector(`.slots[data-g="${g}"]`);
      for(const s of cont.querySelectorAll('.slot')){
        if(!s.dataset.card){ s.dataset.card=code; s.textContent=fmt(code); disable(code,true); return; }
      }
    }
    alert('Все ячейки заняты. Нажмите слот, чтобы освободить.');
  }
  function rm(s){
    if(!s.dataset.card) return;
    const code=s.dataset.card; s.dataset.card=''; s.textContent=''; disable(code,false);
  }
  const fmt = c => c[0]+sym[c[1]];

  function resetAll(){
    document.querySelectorAll('.slot').forEach(s=>{s.dataset.card=''; s.textContent='';});
    document.querySelectorAll('.cb').forEach(b=>b.classList.remove('disabled'));
    document.getElementById('result').hidden=true;
  }
  function demo(){
    resetAll();
    const seq={p1_top:['Ah','Kh','Qh'],p1_mid:['As','Kd','Qd','Jd','Td'],p1_bot:['9s','9h','9d','2c','2d'],
               p2_top:['Js','Jc','2d'],p2_mid:['Qs','Qh','Qd','7s','7h'],p2_bot:['8s','7s','6s','5s','4s']};
    const order=['p1_top','p1_mid','p1_bot','p2_top','p2_mid','p2_bot'];
    order.forEach(g=>seq[g].forEach(place));
  }

  function p5(cards){
    const vals=cards.map(c=>R2V[c[0]]).sort((a,b)=>b-a);
    const suits=cards.map(c=>c[1]);
    const cnt={}; vals.forEach(v=>cnt[v]=(cnt[v]||0)+1);
    const by=Object.entries(cnt).map(([v,f])=>({v:+v,f})).sort((a,b)=>(b.f-a.f)||(b.v-a.v));
    const flush=new Set(suits).size===1;

    const u=[...new Set(vals)].sort((a,b)=>b-a); let straight=false, high=vals[0];
    if(u.length>=5 && u[0]-u[4]===4){ straight=true; high=u[0]; }
    else { const S=new Set(vals); if([14,5,4,3,2].every(x=>S.has(x))){ straight=true; high=5; } }

    if(straight&&flush){ if(high===14) return {rank:[8,14],key:'royal_flush'};
      return {rank:[8,high],key:'straight_flush'}; }
    if(by[0].f===4){ const four=by[0].v; const k=Math.max(...vals.filter(x=>x!==four));
      return {rank:[7,four,k],key:'four_kind'}; }
    if(by[0].f===3 && by[1] && by[1].f===2){ return {rank:[6,by[0].v,by[1].v],key:'full_house'}; }
    if(flush) return {rank:[5,...vals],key:'flush'};
    if(straight) return {rank:[4,high],key:'straight'};
    if(by[0].f===3){ const t=by[0].v; const ks=vals.filter(x=>x!==t).sort((a,b)=>b-a);
      return {rank:[3,t,...ks],key:'three_kind'}; }
    if(by[0].f===2 && by[1] && by[1].f===2){
      const ph=Math.max(by[0].v,by[1].v), pl=Math.min(by[0].v,by[1].v);
      const k=Math.max(...vals.filter(x=>x!==ph && x!==pl));
      return {rank:[2,ph,pl,k],key:'two_pair'};
    }
    if(by[0].f===2){ const p=by[0].v; const ks=vals.filter(x=>x!==p).sort((a,b)=>b-a);
      return {rank:[1,p,...ks],key:'pair'}; }
    return {rank:[0,...vals],key:'high'};
  }
  function p3(cards){
    const v=cards.map(c=>R2V[c[0]]).sort((a,b)=>b-a);
    const cnt={}; v.forEach(x=>cnt[x]=(cnt[x]||0)+1);
    const by=Object.entries(cnt).map(([k,f])=>({v:+k,f})).sort((a,b)=>(b.f-a.f)||(b.v-a.v));
    if(by[0].f===3) return {rank:[2,by[0].v]};
    if(by[0].f===2){ const pair=by[0].v; const k=Math.max(...v.filter(x=>x!==pair)); return {rank:[1,pair,k]}; }
    return {rank:[0,...v]};
  }
  const cmp=(a,b)=>{for(let i=0;i<Math.max(a.length,b.length);i++){const A=a[i]??-1e9,B=b[i]??-1e9;if(A>B)return 1;if(A<B)return -1}return 0};

  const royT = cs => { const r=p3(cs).rank; if(r[0]===2) return TT[r[1]]||0; if(r[0]===1) return TP[r[1]]||0; return 0; };
  const royM = cs => { const h=p5(cs); let k=h.key; if(k==='straight_flush' && h.rank[1]===14) k='royal_flush'; return RM[k]||0; };
  const royB = cs => { const h=p5(cs); let k=h.key; if(k==='straight_flush' && h.rank[1]===14) k='royal_flush'; return RB[k]||0; };

  const foul = (top,mid,bot) => cmp(p5(bot).rank, p5(mid).rank) < 0;

  const collect = g => Array.from(document.querySelector(`.slots[data-g="${g}"]`).querySelectorAll('.slot')).map(s=>s.dataset.card).filter(Boolean);

  function calc(){
    const unit = parseFloat(document.getElementById('unit').value||'50');
    const p1={top:collect('p1_top'),mid:collect('p1_mid'),bot:collect('p1_bot')};
    const p2={top:collect('p2_top'),mid:collect('p2_mid'),bot:collect('p2_bot')};
    if(p1.top.length!==3||p1.mid.length!==5||p1.bot.length!==5||p2.top.length!==3||p2.mid.length!==5||p2.bot.length!==5){ alert('У каждого игрока 3/5/5 карт.'); return; }
    const all=[...p1.top,...p1.mid,...p1.bot,...p2.top,...p2.mid,...p2.bot]; if(new Set(all).size!==all.length){ alert('Дубли карт.'); return; }
    const f1=foul(p1.top,p1.mid,p1.bot), f2=foul(p2.top,p2.mid,p2.bot);
    let rt1=0,rm1=0,rb1=0,rt2=0,rm2=0,rb2=0;
    if(!f1){ rt1=royT(p1.top); rm1=royM(p1.mid); rb1=royB(p1.bot); }
    if(!f2){ rt2=royT(p2.top); rm2=royM(p2.mid); rb2=royB(p2.bot); }
    let pts1=0, pts2=0, note='', topRes='—', midRes='—', botRes='—';
    if(f1||f2){
      if(f1&&!f2){ pts1=-6; pts2=+6+(rt2+rm2+rb2); note='Игрок 1 сжёг руку.'; }
      else if(f2&&!f1){ pts1=+6+(rt1+rm1+rb1); pts2=-6; note='Игрок 2 сжёг руку.'; }
      else { note='Оба сожгли, линии не считаются.'; }
    } else {
      const t1=p3(p1.top).rank,t2=p3(p2.top).rank,m1=p5(p1.mid).rank,m2=p5(p2.mid).rank,b1=p5(p1.bot).rank,b2=p5(p2.bot).rank;
      const ct=cmp(t1,t2), cm=cmp(m1,m2), cb=cmp(b1,b2);
      const w1=(ct>0)+(cm>0)+(cb>0), w2=(ct<0)+(cm<0)+(cb<0);
      topRes=ct>0?'P1':(ct<0?'P2':'Пуш'); midRes=cm>0?'P1':(cm<0?'P2':'Пуш'); botRes=cb>0?'P1':(cb<0?'P2':'Пуш');
      const s1=(w1===3)?3:0, s2=(w2===3)?3:0; if(s1&&!s2) note='Scoop игрока 1 (+3).'; if(s2&&!s1) note='Scoop игрока 2 (+3).';
      pts1=(w1-w2)+(s1-s2)+((rt1+rm1+rb1)-(rt2+rm2+rb2)); pts2=-pts1;
    }
    document.getElementById('result').hidden=false;
    document.getElementById('lines').innerHTML = `
      <tr><td>Верх</td><td>${topRes}</td><td>${rt1}</td><td>${rt2}</td></tr>
      <tr><td>Середина</td><td>${midRes}</td><td>${rm1}</td><td>${rm2}</td></tr>
      <tr><td>Низ</td><td>${botRes}</td><td>${rb1}</td><td>${rb2}</td></tr>`;
    document.getElementById('sum').innerHTML = `
      <table><tr><th></th><th>Очки</th><th>Рубли</th></tr>
      <tr><td>Игрок 1</td><td>${pts1}</td><td>${Math.round(pts1*unit)}</td></tr>
      <tr><td>Игрок 2</td><td>${pts2}</td><td>${Math.round(pts2*unit)}</td></tr></table>`;
    document.getElementById('notes').textContent = note;
  }

  document.getElementById('reset').addEventListener('click', resetAll);
  document.getElementById('demo').addEventListener('click', demo);
  document.getElementById('calc').addEventListener('click', calc);
  slotsBuild(); deckBuild();

  // PWA SW
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('sw.js')); }
})();
</script>
</body>
</html>
